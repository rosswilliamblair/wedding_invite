document.addEventListener("DOMContentLoaded", () => {

  const board = document.getElementById("board");

  // --- build board ---
  for(let r=8;r>=1;r--){
    for(let c=0;c<8;c++){
      const sq = document.createElement("div");
      sq.className = "square " + ((r+c)%2===0 ? "light":"dark");
      sq.dataset.square = String.fromCharCode(97+c)+r;
      board.appendChild(sq);
    }
  }

  // --- initial positions & setup function ---
  const initialPositions = [
    ["d3","bishop_white"],["b4","queen_white"],["b1","king_white"],["h2","rook_white"],
    ["a2","pawn_white"],["b2","pawn_white"],["c2","pawn_white"],["c1","rook_white"],
    ["g8","king_black"],["f8","rook_black"],["f7","pawn_black"],["g7","pawn_black"],["h7","pawn_black"],
    ["h8","knight_black"],["d8","knight_white"]
  ];

  function addPiece(square,type){
    const sq = [...board.children].find(s => s.dataset.square===square);
    const pieceDiv = document.createElement("div");
    pieceDiv.className="piece";
    pieceDiv.draggable = true;
    pieceDiv.dataset.type = type;

    const img = document.createElement("img");
    img.src = type + ".png";
    pieceDiv.appendChild(img);

    sq.appendChild(pieceDiv);
  }

  function setupPieces(){
    [...board.children].forEach(sq => sq.innerHTML=""); 
    initialPositions.forEach(pos => addPiece(pos[0],pos[1]));
    document.getElementById("unlock").style.display="none";
    document.getElementById("message").textContent="";
  }

  setupPieces();

  // --- drag & drop ---
  let dragged=null;

  document.addEventListener("dragstart",e=>{
    if(e.target.classList.contains("piece")) dragged = e.target;
  });

  document.addEventListener("dragover",e=>{
    if(e.target.classList.contains("square") || e.target.closest(".square")) e.preventDefault();
  });

  document.addEventListener("drop",e=>{
    let target = e.target.closest(".square");
    if(target && dragged){
      e.preventDefault();
      target.innerHTML="";
      target.appendChild(dragged);
      checkMove(dragged,target);
      dragged=null;
    }
  });

  // --- click-to-move ---
  let selectedSquare = null;

  [...board.children].forEach(square => {
    square.addEventListener("click", () => {
      if(selectedSquare === null){
        if(square.querySelector(".piece")){
          selectedSquare = square;
          square.classList.add("selected");
        }
      } else if(selectedSquare === square){
        square.classList.remove("selected");
        selectedSquare = null;
      } else {
        const movingPiece = selectedSquare.querySelector(".piece");
        if(movingPiece){
          square.innerHTML="";
          square.appendChild(movingPiece);
          checkMove(movingPiece,square);
        }
        selectedSquare.classList.remove("selected");
        selectedSquare=null;
      }
    });
  });

  // --- move checking ---
  function checkMove(piece,target){
    if(piece.dataset.type==="bishop_white" && target.dataset.square==="h7"){
      document.getElementById("unlock").style.display="block";
      target.classList.add("correct");
      setTimeout(()=>{ target.classList.remove("correct"); },1500);
    } else {
      target.classList.add("wrong");
      const funnyMessages = [
        "Whoops! Resetting the board for you.",
        "Nice imagination, terrible execution!",
        "Wrong move! Donâ€™t worry, even grandmasters fail."
      ];
      document.getElementById("message").textContent = funnyMessages[Math.floor(Math.random()*funnyMessages.length)];
      setTimeout(()=>{
        target.classList.remove("wrong");
        setupPieces();
      },1200);
    }
  }

}); // end DOMContentLoaded
